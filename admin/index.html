<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - WaiWai.diy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/marked@4.0.0/marked.min.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="min-h-screen">
        <nav class="bg-gray-800 border-b border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <span class="text-xl font-bold">WaiWai.diy Admin</span>
                        </div>
                    </div>
                    <div>
                        <button id="logoutBtn" class="text-gray-300 hover:text-white px-3 py-2">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-semibold">Articles</h1>
                    <button id="newArticleBtn" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-md">
                        New Article
                    </button>
                </div>

                <div class="bg-gray-800 shadow rounded-lg">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Title
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Status
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Created At
                                </th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="articlesTable" class="divide-y divide-gray-700">
                            <!-- Articles will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- New/Edit Article Modal -->
    <div id="articleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-800 rounded-lg w-full max-w-4xl">
                <div class="p-6">
                    <h2 id="modalTitle" class="text-xl font-semibold mb-4">New Article</h2>
                    <form id="articleForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Title</label>
                            <input type="text" id="articleTitle" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">SEO Title</label>
                            <input type="text" id="seoTitle" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">SEO Description</label>
                            <textarea id="seoDescription" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Content (Markdown)</label>
                            <textarea id="content" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md h-64"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Image</label>
                            <input type="file" id="image" accept="image/*" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md">
                        </div>
                        <div class="flex justify-between">
                            <div>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="isPublished" class="form-checkbox bg-gray-700">
                                    <span class="ml-2">Published</span>
                                </label>
                            </div>
                            <div>
                                <button type="button" id="cancelBtn" class="px-4 py-2 text-gray-300 hover:text-white">
                                    Cancel
                                </button>
                                <button type="submit" class="ml-3 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md">
                                    Save
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from '../js/supabase.js';

        // Check authentication
        const checkAuth = async () => {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '/admin/login.html';
            }
        };
        checkAuth();

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = '/admin/login.html';
        });

        // Load articles
        const loadArticles = async () => {
            const { data: articles, error } = await supabase
                .from('articles')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading articles:', error);
                return;
            }

            const tableBody = document.getElementById('articlesTable');
            tableBody.innerHTML = articles.map(article => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">${article.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            article.is_published 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${article.is_published ? 'Published' : 'Draft'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${new Date(article.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-400 hover:text-indigo-300 mr-3" onclick="editArticle('${article.id}')">
                            Edit
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteArticle('${article.id}')">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        };

        // Initial load
        loadArticles();

        // Modal handlers
        const modal = document.getElementById('articleModal');
        const form = document.getElementById('articleForm');
        let currentArticleId = null;

        document.getElementById('newArticleBtn').addEventListener('click', () => {
            currentArticleId = null;
            form.reset();
            document.getElementById('modalTitle').textContent = 'New Article';
            modal.classList.remove('hidden');
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Handle form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('articleTitle').value,
                seo_title: document.getElementById('seoTitle').value,
                seo_description: document.getElementById('seoDescription').value,
                content: document.getElementById('content').value,
                is_published: document.getElementById('isPublished').checked,
                slug: document.getElementById('articleTitle').value
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '')
            };

            const imageFile = document.getElementById('image').files[0];
            if (imageFile) {
                const { data, error } = await supabase.storage
                    .from('article-images')
                    .upload(`${Date.now()}-${imageFile.name}`, imageFile);

                if (error) {
                    alert('Error uploading image: ' + error.message);
                    return;
                }

                formData.image_path = data.path;
            }

            const { data, error } = currentArticleId
                ? await supabase
                    .from('articles')
                    .update(formData)
                    .eq('id', currentArticleId)
                : await supabase
                    .from('articles')
                    .insert([formData]);

            if (error) {
                alert('Error saving article: ' + error.message);
                return;
            }

            modal.classList.add('hidden');
            loadArticles();
        });

        // Edit article
        window.editArticle = async (id) => {
            const { data: article, error } = await supabase
                .from('articles')
                .select('*')
                .eq('id', id)
                .single();

            if (error) {
                alert('Error loading article: ' + error.message);
                return;
            }

            currentArticleId = id;
            document.getElementById('modalTitle').textContent = 'Edit Article';
            document.getElementById('articleTitle').value = article.title;
            document.getElementById('seoTitle').value = article.seo_title;
            document.getElementById('seoDescription').value = article.seo_description;
            document.getElementById('content').value = article.content;
            document.getElementById('isPublished').checked = article.is_published;
            modal.classList.remove('hidden');
        };

        // Delete article
        window.deleteArticle = async (id) => {
            if (!confirm('Are you sure you want to delete this article?')) {
                return;
            }

            const { error } = await supabase
                .from('articles')
                .delete()
                .eq('id', id);

            if (error) {
                alert('Error deleting article: ' + error.message);
                return;
            }

            loadArticles();
        };
    </script>
</body>
</html> 